# modifica capo uscita

def modificacapousc(selcapo)
	modcapousc = Gtk::Window.new("Modifica movimento di uscita")
	#modcapousc.window_position=(Gtk::Window::POS_CENTER_ALWAYS)
	modcapousc.set_default_size(800, 600)
	modcapousc.maximize
	boxgen = Gtk::VBox.new(false, 0)
	boxgrande = Gtk::HBox.new(false, 0)
	boxmodcv1 = Gtk::HBox.new(false, 0)
	boxmodcv11 = Gtk::VBox.new(true, 0)
	boxmodcv12 = Gtk::VBox.new(true, 0)
	boxmodcv2 = Gtk::HBox.new(false, 0)
	boxmodcv21 = Gtk::VBox.new(true, 0)
	boxmodcv22 = Gtk::VBox.new(true, 0)
	boxmodc1 = Gtk::HBox.new(false, 0)
	boxmodc2 = Gtk::HBox.new(false, 0)
	boxmodc3 = Gtk::HBox.new(false, 0)
	boxmodc4 = Gtk::HBox.new(false, 0)
	boxmodc5 = Gtk::HBox.new(false, 0)
	boxmodc6 = Gtk::HBox.new(false, 0)
	boxmodc7 = Gtk::HBox.new(false, 0)
	boxmodc8 = Gtk::HBox.new(false, 0)
	boxmodc9 = Gtk::HBox.new(false, 0)
	boxmodc10 = Gtk::HBox.new(false, 0)
	boxmodc11 = Gtk::HBox.new(false, 0)
	boxmodc12 = Gtk::HBox.new(false, 0)
	boxmodc13 = Gtk::HBox.new(false, 0)
	boxmodc14 = Gtk::HBox.new(false, 0)
	boxmodc15 = Gtk::HBox.new(false, 0)
	boxmodc16 = Gtk::HBox.new(false, 0)
	boxmodc17 = Gtk::HBox.new(false, 0)
	boxmodc18 = Gtk::HBox.new(false, 0)
	boxmodc19 = Gtk::HBox.new(false, 0)
	boxmodc20 = Gtk::HBox.new(false, 0)
	boxmodc21 = Gtk::HBox.new(false, 0)
	boxmodc22 = Gtk::HBox.new(false, 0)
	boxmodc23 = Gtk::HBox.new(false, 0)
	boxmodc24 = Gtk::HBox.new(false, 0)
	boxmodc25 = Gtk::HBox.new(false, 0)
	boxmodc26 = Gtk::HBox.new(false, 0)
	boxmodc27 = Gtk::HBox.new(false, 0)
	boxmodc28 = Gtk::HBox.new(false, 0)
	boxmodc29 = Gtk::HBox.new(false, 0)
	boxmodc30 = Gtk::HBox.new(false, 0)
	boxmodc31 = Gtk::HBox.new(false, 0)
	boxmodc32 = Gtk::HBox.new(false, 0)
	boxmodc33 = Gtk::HBox.new(false, 0)
	boxmodc34 = Gtk::HBox.new(false, 0)
	boxmodc35 = Gtk::HBox.new(false, 0)
	boxmodc36 = Gtk::HBox.new(false, 0)
	boxmodc37 = Gtk::HBox.new(false, 0)
	boxmodc38 = Gtk::HBox.new(false, 0)
	boxmodc39 = Gtk::HBox.new(false, 0)
	boxmodc40 = Gtk::HBox.new(false, 0)
	boxmodc41 = Gtk::HBox.new(false, 0)
	boxmodc42 = Gtk::HBox.new(false, 0)
	boxmodc43 = Gtk::HBox.new(false, 0)
	boxmodc44 = Gtk::HBox.new(false, 0)
	boxmodc45 = Gtk::HBox.new(false, 0)
	boxmodc46 = Gtk::HBox.new(false, 0)
	boxmodc47 = Gtk::HBox.new(false, 0)
	boxmodc48 = Gtk::HBox.new(false, 0)
	boxmodc100 = Gtk::HBox.new(true, 0)
	boxmodcv11.pack_start(boxmodc1, false, false, 0)
	boxmodcv12.pack_start(boxmodc2, false, false, 0)
	boxmodcv11.pack_start(boxmodc3, false, false, 0)
	boxmodcv12.pack_start(boxmodc4, false, false, 0)
	boxmodcv11.pack_start(boxmodc5, false, false, 0)
	boxmodcv12.pack_start(boxmodc6, false, false, 0)
	boxmodcv11.pack_start(boxmodc7, false, false, 0)
	boxmodcv12.pack_start(boxmodc8, false, false, 0)
	boxmodcv11.pack_start(boxmodc9, false, false, 0)
	boxmodcv12.pack_start(boxmodc10, false, false, 0)
	boxmodcv11.pack_start(boxmodc11, false, false, 0)
	boxmodcv12.pack_start(boxmodc12, false, false, 0)
	boxmodcv11.pack_start(boxmodc13, false, false, 0)
	boxmodcv12.pack_start(boxmodc14, false, false, 0)
	boxmodcv11.pack_start(boxmodc15, false, false, 0)
	boxmodcv12.pack_start(boxmodc16, false, false, 0)
	boxmodcv11.pack_start(boxmodc17, false, false, 0)
	boxmodcv12.pack_start(boxmodc18, false, false, 0)
	boxmodcv11.pack_start(boxmodc19, false, false, 0)
	boxmodcv12.pack_start(boxmodc20, false, false, 0)
	boxmodcv11.pack_start(boxmodc21, false, false, 0)
	boxmodcv12.pack_start(boxmodc22, false, false, 0)
	boxmodcv11.pack_start(boxmodc23, false, false, 0)
	boxmodcv12.pack_start(boxmodc24, false, false, 0)
	boxmodcv21.pack_start(boxmodc25, false, false, 0)
	boxmodcv22.pack_start(boxmodc26, false, false, 0)
	boxmodcv21.pack_start(boxmodc27, false, false, 0)
	boxmodcv22.pack_start(boxmodc28, false, false, 0)
	boxmodcv21.pack_start(boxmodc29, false, false, 0)
	boxmodcv22.pack_start(boxmodc30, false, false, 0)
	boxmodcv21.pack_start(boxmodc31, false, false, 0)
	boxmodcv22.pack_start(boxmodc32, false, false, 0)
	boxmodcv21.pack_start(boxmodc33, false, false, 0)
	boxmodcv22.pack_start(boxmodc34, false, false, 0)
	boxmodcv21.pack_start(boxmodc35, false, false, 0)
	boxmodcv22.pack_start(boxmodc36, false, false, 0)
	boxmodcv21.pack_start(boxmodc37, false, false, 0)
	boxmodcv22.pack_start(boxmodc38, false, false, 0)
	boxmodcv21.pack_start(boxmodc39, false, false, 0)
	boxmodcv22.pack_start(boxmodc40, false, false, 0)
	boxmodcv21.pack_start(boxmodc41, false, false, 0)
	boxmodcv22.pack_start(boxmodc42, false, false, 0)
	boxmodcv21.pack_start(boxmodc43, false, false, 0)
	boxmodcv22.pack_start(boxmodc44, false, false, 0)
	boxmodcv21.pack_start(boxmodc45, false, false, 0)
	boxmodcv22.pack_start(boxmodc46, false, false, 0)
	boxmodcv21.pack_start(boxmodc47, false, false, 0)
	boxmodcv22.pack_start(boxmodc48, false, false, 0)
	boxmodcv1.pack_start(boxmodcv11, false, false, 0)
	boxmodcv1.pack_start(boxmodcv12, false, false, 0)
	boxmodcv2.pack_start(boxmodcv21, false, false, 0)
	boxmodcv2.pack_start(boxmodcv22, false, false, 0)
	boxgrande.pack_start(boxmodcv1, true, true)
	boxgrande.pack_start(boxmodcv2, true, true)
	boxgen.pack_start(boxgrande, true, true)
	boxgen.pack_start(boxmodc100, false, false)
	modcapousc.add(boxgen)

	#Modifica marca

	capomod = selcapo.selected
	labelmarca = Gtk::Label.new("Marca:")
	boxmodc1.pack_end(labelmarca, false, false, 5)
	marca = Gtk::Entry.new()
	marca.max_length=(14)
	marca.text = ("#{capomod[3]}")
	boxmodc2.pack_start(marca, false, false, 5)

	#Specie

	labelspecie = Gtk::Label.new("Specie:")
	boxmodc3.pack_end(labelspecie, false, false, 5)
	specie1 = Gtk::RadioButton.new("Bovini")
	boxmodc4.pack_start(specie1, false, false, 5)
	specie2 = Gtk::RadioButton.new(specie1, "Bufalini")
	boxmodc4.pack_start(specie2, false, false, 5)
	valspecie = capomod[4]
	if capomod[4] == "BOV"
		specie1.active=(true)
	else
		specie2.active=(true)
	end

	specie1.signal_connect("toggled") {
		if specie1.active?
			valspecie = "BOV" 
		end
	}
	specie2.signal_connect("toggled") {
		if specie2.active?
			valspecie = "BUF"
		end
	}

	#Modifica razza

	labelrazza = Gtk::Label.new("Razza:")
	listarazze = Gtk::ListStore.new(Integer, String, String)
	selrazze = Razzas.find(:all)
	selrazze.each do |r|
		iter1 = listarazze.append
		iter1[0] = r.id.to_i
		iter1[1] = r.razza
		iter1[2] = r.cod_razza
	end
	comborazze = Gtk::ComboBox.new(listarazze)
	renderer1 = Gtk::CellRendererText.new
	comborazze.pack_start(renderer1,false)
	comborazze.set_attributes(renderer1, :text => 1)
	renderer1 = Gtk::CellRendererText.new
	renderer1.visible=(false)
	comborazze.pack_end(renderer1,false)
	comborazze.set_attributes(renderer1, :text => 2)
	boxmodc5.pack_end(labelrazza, false, false, 5)
	boxmodc6.pack_start(comborazze.popdown, false, false, 0)

	comborazze.set_active(0)
	contarazze = -1
	while comborazze.active_iter[1] != capomod[5]
		contarazze+=1
		comborazze.set_active(contarazze)
	end

	#Modifica data di nascita

	labelnascita = Gtk::Label.new("Data di nascita (GGMMAA):")
	boxmodc7.pack_end(labelnascita, false, false, 5)
	nascita = Gtk::Entry.new()
	nascita.max_length=(6)
	nascita.text = ("#{capomod[6][0,2]}#{capomod[6][3,2]}#{capomod[6][8,2]}")
	boxmodc8.pack_start(nascita, false , false, 0)

	#Modifica sesso

	labelsesso = Gtk::Label.new("Sesso:")
	boxmodc9.pack_end(labelsesso, false, false, 5)
	sesso1 = Gtk::RadioButton.new("M")
	boxmodc10.pack_start(sesso1, false, false, 5)
	sesso2 = Gtk::RadioButton.new(sesso1, "F")
	boxmodc10.pack_start(sesso2, false, false, 5)
	valsesso = capomod[8]
	if capomod[8] == "M"
		sesso1.active=(true)
	else
		sesso2.active=(true)
	end

	sesso1.signal_connect("toggled") {
		if sesso1.active?
			valsesso="M"
		end
	}
	sesso2.signal_connect("toggled") {
		if sesso2.active?
			valsesso="F"
		end
	}

	#Modifica stalla di nascita / prima importazione

	labelstallanas = Gtk::Label.new("Stalla nascita / prima importazione:")
	stallanas = Gtk::Entry.new()
	stallanas.max_length=(8)
	stallanas.text = ("#{capomod[7]}")
	boxmodc11.pack_end(labelstallanas, false, false, 5)
	boxmodc12.pack_start(stallanas, false, false, 5)

	#Nazione origine

	labelnazorig = Gtk::Label.new("Nazione di origine:")
	boxmodc13.pack_end(labelnazorig, false, false, 5)
	listanazorig = Gtk::ListStore.new(Integer, String, String, Integer)
	listanazorig.clear
	selnazorig = Nations.find(:all, :order => "nome")
	selnazorig.each do |no|
		iter1 = listanazorig.append
		iter1[0] = no.id
		iter1[1] = no.nome
		iter1[2] = no.codice
		iter1[3] = no.tipo
	end
	combonazorig = Gtk::ComboBox.new(listanazorig)
	renderer1 = Gtk::CellRendererText.new
	renderer1.visible=(false)
	combonazorig.pack_start(renderer1,false)
	combonazorig.set_attributes(renderer1, :text => 0)
	renderer1 = Gtk::CellRendererText.new
	combonazorig.pack_start(renderer1,false)
	combonazorig.set_attributes(renderer1, :text => 1)
	renderer1 = Gtk::CellRendererText.new
	renderer1.visible=(false)
	combonazorig.pack_start(renderer1,false)
	combonazorig.set_attributes(renderer1, :text => 2)
	renderer1 = Gtk::CellRendererText.new
	renderer1.visible=(false)
	combonazorig.pack_start(renderer1,false)
	combonazorig.set_attributes(renderer1, :text => 3)
	boxmodc14.pack_start(combonazorig.popdown, false, false, 0)

	combonazorig.set_active(0)
	contanazorig = -1
	while combonazorig.active_iter[2] != capomod[9]
		contanazorig+=1
		combonazorig.set_active(contanazorig)
	end

	#Nazione nascita / prima importazione

	labelnaznas = Gtk::Label.new("Nazione nascita / prima importazione:")
	boxmodc15.pack_end(labelnaznas, false, false, 5)
	listanaznas = Gtk::ListStore.new(Integer, String, String)
	listanaznas.clear
	selnaznas = Nations.find(:all, :order => "nome")
	selnaznas.each do |n|
		iter1 = listanaznas.append
		iter1[0] = n.id
		iter1[1] = n.nome
		iter1[2] = n.codice
	end
	combonaznas = Gtk::ComboBox.new(listanaznas)
	renderer1 = Gtk::CellRendererText.new
	renderer1.visible=(false)
	combonaznas.pack_start(renderer1,false)
	combonaznas.set_attributes(renderer1, :text => 0)
	renderer1 = Gtk::CellRendererText.new
	combonaznas.pack_start(renderer1,false)
	combonaznas.set_attributes(renderer1, :text => 1)
	renderer1 = Gtk::CellRendererText.new
	renderer1.visible=(false)
	combonaznas.pack_start(renderer1,false)
	combonaznas.set_attributes(renderer1, :text => 2)
	boxmodc16.pack_start(combonaznas.popdown, false, false, 0)
	combonaznas.set_active(0)
	contanaznas = -1
	while combonaznas.active_iter[2] != capomod[10]
		contanaznas+=1
		combonaznas.set_active(contanaznas)
	end

	#Data applicazione marca

	labelmarcatura = Gtk::Label.new("Data applicazione marca (GGMMAA):")
	boxmodc17.pack_end(labelmarcatura, false, false, 5)
	marcatura = Gtk::Entry.new()
	marcatura.max_length=(6)
	if capomod[11] != nil
		marcatura.text = ("#{capomod[11][0,2]}#{capomod[11][3,2]}#{capomod[11][8,2]}")
	end
	boxmodc18.pack_start(marcatura, false, false, 0)

	#Iscrizione libro genealogico

	labelgen = Gtk::Label.new("Iscrizione libro genealogico:")
	boxmodc19.pack_end(labelgen, false, false, 5)
	gen1 = Gtk::RadioButton.new("S")
	boxmodc20.pack_start(gen1, false, false, 5)
	gen2 = Gtk::RadioButton.new(gen1, "N")
	boxmodc20.pack_start(gen2, false, false, 5)
	gen3 = Gtk::RadioButton.new(gen1, "NULLO")
	boxmodc20.pack_start(gen3, false, false, 5)
	valgen = capomod[12]
	if capomod[12] == "S"
		gen1.active=(true)
	elsif capomod[12] == "N"
		gen2.active=(true)
	else
		gen3.active=(true)
	end

	gen1.signal_connect("toggled") {
		if gen1.active?
			valgen="S"
		end
	}
	gen2.active=(true)
	gen2.signal_connect("toggled") {
		if gen2.active?
			valgen="N"
		end
	}
	gen3.signal_connect("toggled") {
		if gen3.active?
			valgen="NULLO"
		end
	}

	#Marca precedente

	labelprec = Gtk::Label.new("Marca precedente:")
	boxmodc21.pack_end(labelprec, false, false, 5)
	prec = Gtk::Entry.new()
	prec.max_length=(14)
	prec.text = ("#{capomod[13]}")
	boxmodc22.pack_start(prec, false, false, 5)

	#Marca madre

	labelmadre = Gtk::Label.new("Marca madre:")
	boxmodc23.pack_end(labelmadre, false, false, 5)
	madre = Gtk::Entry.new()
	madre.max_length=(14)
	madre.text = ("#{capomod[14]}")
	boxmodc24.pack_start(madre, false, false, 5)

	#Modifica motivo uscita

	labelmovusc = Gtk::Label.new("Motivo uscita:")
	listamovusc = Gtk::ListStore.new(Integer, String)
	selmovusc = Uscites.find(:all)
	selmovusc.each do |u|
		iter1 = listamovusc.append
		iter1[0] = u.codice.to_i
		iter1[1] = u.descr
	end

	combomovusc = Gtk::ComboBox.new(listamovusc)
	renderer1 = Gtk::CellRendererText.new
	renderer1.visible=(false)
	combomovusc.pack_start(renderer1,false)
	combomovusc.set_attributes(renderer1, :text => 0)
	renderer1 = Gtk::CellRendererText.new
	combomovusc.pack_start(renderer1,false)
	combomovusc.set_attributes(renderer1, :text => 1)
	boxmodc25.pack_end(labelmovusc, false, false, 5)
	boxmodc26.pack_start(combomovusc.popdown, false, false, 0)
	combomovusc.set_active(0)
	contamovusc = -1
	while combomovusc.active_iter[0].to_i != capomod[28].to_i
		contamovusc+=1
		combomovusc.set_active(contamovusc)
	end

	#Modifica data uscita

	labeldatausc = Gtk::Label.new("Data di uscita (GGMMAA):")
	boxmodc27.pack_end(labeldatausc, false, false, 5)
	datausc = Gtk::Entry.new()
	datausc.max_length=(6)
	datausc.text = ("#{capomod[29][0,2]}#{capomod[29][3,2]}#{capomod[29][8,2]}")
	boxmodc28.pack_start(datausc, false , false, 0)

	#Nazione di destinazione

	labelnazdest = Gtk::Label.new("Nazione di destinazione:")
	boxmodc29.pack_end(labelnazdest, false, false, 5)
	listanazdest = Gtk::ListStore.new(Integer, String, String)
	listanazdest.clear
	selnazdest = Nations.find(:all, :order => "nome")
	selnazdest.each do |n|
		iter1 = listanazdest.append
		iter1[0] = n.id
		iter1[1] = n.nome
		iter1[2] = n.codice
	end
	combonazdest = Gtk::ComboBox.new(listanazdest)
	renderer1 = Gtk::CellRendererText.new
	renderer1.visible=(false)
	combonazdest.pack_start(renderer1,false)
	combonazdest.set_attributes(renderer1, :text => 0)
	renderer1 = Gtk::CellRendererText.new
	combonazdest.pack_start(renderer1,false)
	combonazdest.set_attributes(renderer1, :text => 1)
	renderer1 = Gtk::CellRendererText.new
	renderer1.visible=(false)
	combonazdest.pack_start(renderer1,false)
	combonazdest.set_attributes(renderer1, :text => 2)
	boxmodc30.pack_start(combonazdest.popdown, false, false, 0)
	if capomod[31].to_s != ""
		combonazdest.set_active(0)
		contanazdest = -1
		while combonazdest.active_iter[2] != capomod[31]
			contanazdest+=1
			combonazdest.set_active(contanazdest)
		end
	else
	combonazdest.set_active(-1)
	end

	#Certificato sanitario

	labelcertsan = Gtk::Label.new("Certificato sanitario:")
	boxmodc31.pack_end(labelcertsan, false, false, 5)
	certsan = Gtk::Entry.new()
	certsan.max_length=(21)
	certsan.width_chars=(21)
	certsan.text = ("#{capomod[38]}")
	boxmodc32.pack_start(certsan, false, false, 5)

	#Data certificato sanitario

	labeldatacertsan = Gtk::Label.new("Data certificato sanitario (GGMMAA):")
	boxmodc33.pack_end(labeldatacertsan, false, false, 5)
	datacertsan = Gtk::Entry.new()
	datacertsan.max_length=(6)
	if capomod[39] != nil
		datacertsan.text = ("#{capomod[39][0,2]}#{capomod[39][3,2]}#{capomod[39][8,2]}")
	end
	boxmodc34.pack_start(datacertsan, false , false, 0)

	#Allevamento destinazione

	labelalldest = Gtk::Label.new("Allevamento di destinazione:")
	boxmodc35.pack_end(labelalldest, false, false, 5)
	listaalldest = Gtk::ListStore.new(Integer, String, String, String)
	listaalldest.clear
	selalldest = Allevamentis.find(:all, :order => "ragsoc")
	selalldest.each do |a|
		iter1 = listaalldest.append
		iter1[0] = a.id
		iter1[1] = a.ragsoc
		iter1[2] = a.idfisc
		iter1[3] = a.cod317
	end
	comboalldest = Gtk::ComboBox.new(listaalldest)
	renderer1 = Gtk::CellRendererText.new
	renderer1.visible=(false)
	comboalldest.pack_start(renderer1,false)
	comboalldest.set_attributes(renderer1, :text => 0)
	renderer1 = Gtk::CellRendererText.new
	comboalldest.pack_start(renderer1,false)
	comboalldest.set_attributes(renderer1, :text => 1)
	renderer1 = Gtk::CellRendererText.new
	renderer1.visible=(false)
	comboalldest.pack_start(renderer1,false)
	comboalldest.set_attributes(renderer1, :text => 2)
	renderer1 = Gtk::CellRendererText.new
	renderer1.visible=(false)
	comboalldest.pack_start(renderer1,false)
	comboalldest.set_attributes(renderer1, :text => 3)
	boxmodc36.pack_start(comboalldest.popdown, false, false, 5)
	if capomod[30] != ""
		comboalldest.set_active(0)
		contaalldest = -1
		while comboalldest.active_iter[3] != capomod[30]
			contaalldest+=1
			comboalldest.set_active(contaalldest)
		end
		else
		comboalldest.set_active(-1)
	end

	#Macello destinazione

	labelmacdest = Gtk::Label.new("Macello di destinazione:")
	boxmodc37.pack_end(labelmacdest, false, false, 5)
	listamacdest = Gtk::ListStore.new(Integer, String, String, String, String)
	listamacdest.clear
	selmacdest = Macellis.find(:all, :order => "nomemac")
	selmacdest.each do |a|
		iter1 = listamacdest.append
		iter1[0] = a.id
		iter1[1] = a.nomemac
		iter1[2] = a.ifmac
		iter1[3] = a.bollomac
		iter1[4] = a.region.regione
	end
	combomacdest = Gtk::ComboBox.new(listamacdest)
	renderer1 = Gtk::CellRendererText.new
	renderer1.visible=(false)
	combomacdest.pack_start(renderer1,false)
	combomacdest.set_attributes(renderer1, :text => 0)
	renderer1 = Gtk::CellRendererText.new
	combomacdest.pack_start(renderer1,false)
	combomacdest.set_attributes(renderer1, :text => 1)
	renderer1 = Gtk::CellRendererText.new
	renderer1.visible=(false)
	combomacdest.pack_start(renderer1,false)
	combomacdest.set_attributes(renderer1, :text => 2)
	renderer1 = Gtk::CellRendererText.new
	renderer1.visible=(false)
	combomacdest.pack_start(renderer1,false)
	combomacdest.set_attributes(renderer1, :text => 3)
#	renderer1 = Gtk::CellRendererText.new
#	renderer1.visible=(false)
#	combomacdest.pack_start(renderer1,false)
#	combomacdest.set_attributes(renderer1, :text => 4)
	boxmodc38.pack_start(combomacdest.popdown, false, false, 5)
	if capomod[36] != ""
		combomacdest.set_active(0)
		contamacdest = -1
		while combomacdest.active_iter[3] != capomod[36]
			contamacdest+=1
			combomacdest.set_active(contamacdest)
		end
		else
		combomacdest.set_active(-1)
	end

	#Modello 4

	labelmod4 = Gtk::Label.new("Modello 4:")
	boxmodc39.pack_end(labelmod4, false, false, 5)
	mod4 = Gtk::Entry.new()
	mod4.text = ("#{capomod[26]}")
	boxmodc40.pack_start(mod4, false, false, 5)

	#Data modello 4

	labeldatamod4 = Gtk::Label.new("Data modello 4 (GGMMAA):")
	boxmodc41.pack_end(labeldatamod4, false, false, 5)
	datamod4 = Gtk::Entry.new()
	datamod4.max_length=(6)
	if capomod[27] != nil
		datamod4.text = ("#{capomod[27][0,2]}#{capomod[27][3,2]}#{capomod[27][8,2]}")
	end
	boxmodc42.pack_start(datamod4, false , false, 0)

	#Marca sostitutiva

	labelsost = Gtk::Label.new("Marca sostitutiva:")
	boxmodc43.pack_end(labelsost, false, false, 5)
	sost = Gtk::Entry.new()
	sost.max_length=(14)
	sost.text = ("#{capomod[41]}")
	boxmodc44.pack_start(sost, false, false, 5)

	#Bottone di inserimento

	bottmodcapousc = Gtk::Button.new( "Modifica capo" )
	bottmodcapousc.signal_connect("clicked") {
		errore = nil
		begin
			datanasingl = nascita.text[4,2] + nascita.text[2,2] + nascita.text[0,2]
			datanasingl = Time.parse("#{datanasingl}").strftime("%Y")[0,2] + datanasingl
			Time.parse("#{datanasingl}")
			datauscingl = datausc.text[4,2] + datausc.text[2,2] + datausc.text[0,2]
			datauscingl = Time.parse("#{datauscingl}").strftime("%Y")[0,2] + datauscingl
			Time.parse("#{datauscingl}")
			if marca.text == "" or comborazze.active == -1 or nascita.text == "" or combonazorig.active == -1 or combonaznas.active == -1 or combomovusc.active == -1 or stallanas.text == ""
				Errore.avviso(modcapousc, "Mancano dei dati obbligatori.")
				errore = 1
			elsif marca.text[0,2].upcase == "IT" and marca.text.length < 14
				Errore.avviso(modcapousc, "Marca corta.")
				errore = 1
			elsif nascita.text.to_i == 0
				Errore.avviso(modcapousc, "Data di nascita errata.")
				errore = 1
			elsif datausc.text.to_i == 0
				Errore.avviso(modcapousc, "Data di uscita errata.")
				errore = 1
			elsif marcatura.text != "" and marcatura.text.to_i == 0
				Errore.avviso(modcapousc, "lettere.")
				errore = 1
			elsif marcatura.text == "" #or @marcatura.text == 0 	#	elsif @datamod4.text != "" and @datamod4.text.to_i != 0
				datamarcingl = ""
			end
			if Time.parse("#{datanasingl}") > @giorno
				Errore.avviso(modcapousc, "La data di nascita non può essere successiva al giorno odierno.")
				errore = 1
			end
		rescue Exception => errore
			Errore.avviso(modcapousc, "Errore generico")
			errore = 1
		end
		if errore == nil
			dataingingl = datausc.text[4,2] + datausc.text[2,2] + datausc.text[0,2]
			dataingingl = Time.parse("#{dataingingl}").strftime("%Y")[0,2] + dataingingl
		if marcatura.text != ""
			datamarcingl = marcatura.text[4,2] + marcatura.text[2,2] + marcatura.text[0,2]
			datamarcingl = Time.parse("#{datamarcingl}").strftime("%Y")[0,2] + datamarcingl
		else
			datamarcingl = ""
		end
		if datamod4.text != ""
			datamod4ingl = datamod4.text[4,2] + datamod4.text[2,2] + datamod4.text[0,2]
			datamod4ingl = Time.parse("#{datamod4ingl}").strftime("%Y")[0,2] + datamod4ingl
		else
			datamod4ingl = nil
		end
		if datacertsan.text != ""
			datacertsaningl = datacertsan.text[4,2] + datacertsan.text[2,2] + datacertsan.text[0,2]
			datacertsaningl = Time.parse("#{datacertsaningl}").strftime("%Y")[0,2] + datacertsaningl
		else
			datacertsaningl = nil
		end
		if combomacdest.active == -1
			macdest = ""
		else
			macdest = combomacdest.active_iter[0]
		end
		if comboalldest.active == -1
			alldest = ""
		else
			alldest = comboalldest.active_iter[0]
		end
		if combonazdest.active == -1
			nazdest = ""
		else
			nazdest = combonazdest.active_iter[2]
		end
		Animals.update(capomod[0], {:marca => "#{marca.text.upcase}", :specie => "#{valspecie}", :razza_id => "#{comborazze.active_iter[0]}", :data_nas => "#{datanasingl.to_i}", :sesso => "#{valsesso}", :stalla_nas => "#{stallanas.text.upcase}", :naz_orig => "#{combonazorig.active_iter[2]}", :naz_nasprimimp => "#{combonaznas.active_iter[2]}", :data_applm => "#{datamarcingl}", :ilg => "#{valgen}", :marca_prec => "#{prec.text.upcase}", :marca_madre => "#{madre.text.upcase}", :cm_usc => "#{combomovusc.active_iter[0]}", :uscita => "#{datauscingl.to_i}", :naz_dest => "#{nazdest}", :certsanusc => "#{certsan.text.upcase}", :data_certsanusc => "#{datacertsaningl.to_i}", :allevamenti_id => "#{alldest}", :macelli_id => "#{macdest}", :mod4 => "#{mod4.text.upcase}", :data_mod4 => "#{datamod4ingl.to_i}"})

		if capomod[45] == "SI"
			#puts "vero"
			#puts "#{capomod[29][6,4]}-#{capomod[29][3,2]}-#{capomod[29][0,2]}"
			capomodreg = Registros.find(:first, :conditions => "relaz_id='#{@stallaoper.id}' and marca='#{capomod[3]}' and datauscita='#{capomod[29][6,4]}-#{capomod[29][3,2]}-#{capomod[29][0,2]}'")
			#puts capomodreg.id
			#puts capomodreg.marca

			if combomovusc.active_iter[0] == 4
				regusc = "M"
			elsif combomovusc.active_iter[0] == 6
				regusc = "F"
			elsif combomovusc.active_iter[0] == 20
				regusc = "C"
			else
				regusc = "V"
			end
			if combomovusc.active_iter[0] == 4 or combomovusc.active_iter[0] == 6 or combomovusc.active_iter[0] == 10 or combomovusc.active_iter[0] == 11
				regdest = ""
			elsif combomovusc.active_iter[0] == 9
				regdest = combomacdest.active_iter[3]
			else
				regdest = comboalldest.active_iter[3]
			end
			Registros.update(capomodreg.id, {:marca => "#{marca.text.upcase}", :tipouscita => "#{regusc}", :datauscita => "#{datauscingl.to_i}", :destinazione => "#{regdest}", :mod4usc => "#{mod4.text.upcase}", :certsanusc => "#{certsan.text.upcase}"})
		end
	Conferma.conferma(modcapousc, "Movimento modificato.")
	modcapousc.destroy
	end
	}
	boxmodc100.pack_start(bottmodcapousc, false, false, 5)

# Bottone di eliminazione del movimento

	bottelimina = Gtk::Button.new( "Elimina capo" )
	bottelimina.signal_connect("clicked") {
		avviso = Gtk::MessageDialog.new(modcapousc, Gtk::Dialog::DESTROY_WITH_PARENT, Gtk::MessageDialog::QUESTION, Gtk::MessageDialog::BUTTONS_YES_NO, "Elimino il movimento di uscita del capo #{capomod[3]} ?")
		risposta = avviso.run
		avviso.destroy
		if risposta == Gtk::Dialog::RESPONSE_YES
			Animals.delete(capomod[0])
			ingrcapo = Animals.find(:last, :conditions => "relaz_id='#{@stallaoper.id}' and tipo='I' and marca = '#{capomod[3]}' and uscito = '1'")
			Animals.update(ingrcapo.id, {:uscito => "0"})
			Conferma.conferma(modcapousc, "Movimento eliminato.")
			modcapousc.destroy
		else
			Conferma.conferma(modcapousc, "Movimento non eliminato.")
		end
	}
	boxmodc100.pack_start(bottelimina, false, false, 5)

# Bottone di chiusura finestra

	bottchiudi = Gtk::Button.new( "Chiudi" )
	bottchiudi.signal_connect("clicked") {
		modcapousc.destroy
	}
	boxmodc100.pack_start(bottchiudi, false, false, 5)
	modcapousc.show_all

end
